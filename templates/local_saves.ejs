<script>
    document.addEventListener("localsaverestored", () => {
        console.log("The Local Save Restoration has been initiated.");
    });

    function downloadLocalStorageSave(save_key) {
        let data = JSON.parse(localStorage.getItem(save_key));
        let blob = new Blob([JSON.stringify(data)], {type: "application/json"});
        let url = URL.createObjectURL(blob);
        let a = document.createElement('a');
        a.href = url;
        a.download = `${data.name}.json`;
        document.body.appendChild(a);
        a.click();
        window.URL.revokeObjectURL(url);
    }

    // function to upload a savegame into local storage
    function restoreLocalStorageSave(save_key, file_id) {
        let file_input = document.getElementById(file_id);
        let file = file_input.files[0];
        let reader = new FileReader();
        console.log("Restore save: ", save_key);
        reader.onload = function(e) {
            let data = JSON.parse(e.target.result);
            localStorage.setItem(save_key, JSON.stringify(data));

            // trigger the localsaverestored event
            htmx.trigger(file_input, "localsaverestored");
        }
        reader.readAsText(file);
    }
</script>
<div class="description">
    <div>
    This is the local saves menu. Select a savegame slot from below. 
    <br><br>
    Click Restore: To restore a local save into the selected slot. Can overwrite an existing save.
    <br>
    Click Download: To download the game in the selected slot locally. 
    <br>
    </div>
</div>
<div class="save-list-container" style="margin: auto;">
<div class="save-list">
    <% for (let i = 0; i < 9; i++) { %>
        <div class="save-entry">
            <span style="flex-grow: 1;">Slot <%= i %></span>
            <input type="file" hidden
                id="file_<%= i %>"
                onchange="restoreLocalStorageSave('save<%= i %>', 'file_<%= i %>')"
                hx-post
                hx-trigger="localsaverestored"
                hx-ext="submitlocalstorage"
                hx-target="#content"
                hx-swap="innerHTML"
            />
            <label class="save-file-input" for="file_<%= i %>" style="flex-grow: 1;">Restore</label>
            <% if (saveData[`save${i}`]) { %>
                <button 
                    style="flex-grow: 1;"
                    onclick="downloadLocalStorageSave('save<%= i %>')"
                > 
                    Download
                </button>
                <!-- <% console.log(locals) %> -->
                <span class="save-name-label" style="flex-grow: 1;"><%= saveData[`save${i}`].name %></span>
            <% } %>
        </div>
    <% }; %>
</div>
</div>
<div style="display:none">
    <h2 id="header" hx-swap-oob="true">
        SAVE/LOAD MENU
    </h2>
</div>
<div class="response">
    <button
        hx-get="/"
        hx-target="#content"
        hx-swap="innerHTML"
        hx-push-url="true"
    > 
        Return to game
    </button>
</div>
